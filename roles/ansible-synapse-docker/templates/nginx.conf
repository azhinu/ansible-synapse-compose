#####Security tweaks

server_tokens off;
# limit the number of connections per single IP
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;

# limit the number of requests for a given session
limit_req_zone $binary_remote_addr zone=req_limit_per_ip:10m rate=5r/s;

# zone which we want to limit by upper values, we want limit whole server
server {
    limit_conn conn_limit_per_ip 10;
    limit_req zone=req_limit_per_ip burst=10 nodelay;
}

# if the request body size is more than the buffer size, then the entire (or partial)
# request body is written into a temporary file
client_body_buffer_size  128k;

# buffer size for reading client request header -- for testing environment
client_header_buffer_size 3m;

# maximum number and size of buffers for large headers to read from client request
large_client_header_buffers 4 256k;

# read timeout for the request body from client -- for testing environment
client_body_timeout   3m;

# how long to wait for the client to send a request header -- for testing environment
client_header_timeout 3m;

#####Security tweaks END


{% if nginx_tls_disabled == True %}
    #Synapse reverse-proxy
    server {
	    listen 80;
	    listen [::]:80;
	    server_name {{nginx_synapse_domain}};
      access_log off;
      proxy_set_header X-Forwarded-For $remote_addr;

      location /_matrix {
          proxy_pass http://synapse:8008;
          proxy_request_buffering off;
          client_max_body_size 100m;
      }

{% if ma1sd_enabled == True %}
      location /_matrix/identity {
          proxy_pass http://ma1sd:8090;
      }
{% endif %}      
    }
    
{% if riot_enabled == True %}
    server {
      listen 80;
      listen [::]:80;
      server_name {{nginx_riot_domain}};
      access_log off;
      index index.html;
      root /usr/share/nginx/html/riot-web;
      expires 30d;
    }
{% endif %}
#End riot-web    
{% endif %}
#End if TLS disabled




{% if nginx_tls_disabled == False %}
    #Redirect to TLS
    server {
	    listen 80 default_server;
	    listen [::]:80 default_server;
	    server_name _;
	    return 301 https://$host$request_uri;
    }

    #Synapse reverse-proxy
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name {{nginx_synapse_domain}};
        access_log off;
        proxy_set_header X-Forwarded-For $remote_addr;

        location /_matrix {
            proxy_pass http://synapse:8008;
            proxy_request_buffering off;
            client_max_body_size 100m;
        }
        
{% if ma1sd_enabled == True %}
        location /_matrix/identity {
            proxy_pass http://ma1sd:8090;
        }
{% endif %}
    }
    #End Synapse reverse-proxy
    
{% if riot_enabled == True %}
    server {
      listen 443 ssl http2;
      listen [::]:443 ssl http2;
      server_name {{nginx_riot_domain}};
      access_log off;
      index index.html;
      root /usr/share/nginx/html/riot-web;
      expires 30d;
    }
{% endif %}
#End riot-web
{% endif %}
#End TLS
